{
  ServerSet serverSet=new ServerSetImpl(zkClient,SERVERSET_PATH.get());
  Optional<InetSocketAddress> primarySocket=serviceRegistry.getPrimarySocket();
  if (!primarySocket.isPresent()) {
    throw new IllegalStateException("No primary service registered with LocalServiceRegistry.");
  }
  final EndpointStatus endpointStatus;
  try {
    endpointStatus=serverSet.join(primarySocket.get(),serviceRegistry.getAuxiliarySockets(),initialStatus);
    endpointSupplier.set(endpointStatus);
  }
 catch (  JoinException e) {
    LOG.log(Level.WARNING,"Failed to join ServerSet.",e);
    throw new RuntimeException(e);
  }
catch (  InterruptedException e) {
    LOG.log(Level.WARNING,"Interrupted while joining ServerSet.",e);
    Thread.currentThread().interrupt();
    throw new RuntimeException(e);
  }
  shutdownRegistry.addAction(new ExceptionalCommand<UpdateException>(){
    @Override public void execute() throws UpdateException {
      LOG.info("Leaving ServerSet.");
      endpointStatus.update(Status.DEAD);
    }
  }
);
}

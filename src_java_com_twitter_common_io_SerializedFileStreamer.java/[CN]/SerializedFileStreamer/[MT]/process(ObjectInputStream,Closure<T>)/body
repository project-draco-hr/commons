{
  Object o;
  int count=0;
  try {
    while ((o=inputStream.readObject()) != null) {
      try {
        T t=(T)o;
        if (filter.apply(t)) {
          if (endCondition.apply(t)) {
            break;
          }
          work.execute(t);
          ++count;
        }
      }
 catch (      ClassCastException e) {
        LOG.log(Level.SEVERE,"Unexpected object " + o.toString() + " in stream: ",e);
      }
    }
  }
 catch (  EOFException e) {
    LOG.log(Level.INFO,"Read " + count + " objects from stream.");
  }
catch (  ClassNotFoundException e) {
    LOG.log(Level.SEVERE,"Unexpected class in stream.");
    throw new RuntimeException(e);
  }
catch (  IOException e) {
    LOG.log(Level.SEVERE,"Error reading from stream.");
    throw new RuntimeException(e);
  }
catch (  NullPointerException e) {
    LOG.log(Level.SEVERE,"Unexpected data in status file stream.");
    throw new RuntimeException(e);
  }
 finally {
    try {
      inputStream.close();
    }
 catch (    IOException e) {
      LOG.log(Level.SEVERE,"Can't close stream.",e);
    }
  }
}

def assert_commit_serialization(rwrepo, commit_id, print_performance_info=False):
    'traverse all commits in the history of commit identified by commit_id and check \n\tif the serialization works.\n\t:param print_performance_info: if True, we will show how fast we are'
    ns = 0
    nds = 0
    st = time.time()
    for cm in rwrepo.commit(commit_id).traverse():
        nds += 1
        stream = StringIO()
        cm._serialize(stream)
        ns += 1
        streamlen = stream.tell()
        stream.seek(0)
        istream = rwrepo.odb.store(IStream(Commit.type, streamlen, stream))
        assert (istream.hexsha == cm.hexsha)
        nc = Commit(rwrepo, Commit.NULL_BIN_SHA, cm.tree, cm.author, cm.authored_date, cm.author_tz_offset, cm.committer, cm.committed_date, cm.committer_tz_offset, cm.message, cm.parents, cm.encoding)
        assert (nc.parents == cm.parents)
        stream = StringIO()
        nc._serialize(stream)
        ns += 1
        streamlen = stream.tell()
        stream.seek(0)
        istream.size = streamlen
        istream.stream = stream
        istream.binsha = None
        nc.binsha = rwrepo.odb.store(istream).binsha
        assert (nc.hexsha == cm.hexsha)
    elapsed = (time.time() - st)
    if print_performance_info:
        print  >> sys.stderr, ('Serialized %i and deserialized %i commits in %f s ( (%f, %f) commits / s' % (ns, nds, elapsed, (ns / elapsed), (nds / elapsed)))

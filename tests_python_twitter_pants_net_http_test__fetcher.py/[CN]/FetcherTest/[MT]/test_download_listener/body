def test_download_listener(self):
    downloaded = ''
    for chunk in self.expect_get('http://foo', chunk_size_bytes=1048576, timeout_secs=3600):
        self.listener.recv_chunk(chunk)
        downloaded += chunk
    self.listener.finished()
    self.response.close()
    self.mox.ReplayAll()
    with closing(Compatibility.StringIO()) as fp:
        self.fetcher.fetch('http://foo', Fetcher.DownloadListener(fp).wrap(self.listener), chunk_size=Amount(1, Data.MB), timeout=Amount(1, Time.HOURS))
        self.assertEqual(downloaded, fp.getvalue())

def write(self, filename):
    chroot = self._env.chroot().dup()
    chroot.zip((filename + '~'))
    with open(filename, 'wb') as pexfile:
        pexfile.write(Compatibility.to_bytes(('%s\n' % self._identity.hashbang())))
        with open((filename + '~'), 'rb') as pexfile_zip:
            pexfile.write(pexfile_zip.read())
    chroot.delete()
    os.unlink((filename + '~'))
    chmod_plus_x(filename)

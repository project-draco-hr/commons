def test_use_cache():
    with test_env() as (f, cache):
        key = CacheKey('muppet_key', 'fake_hash', 42)
        cache.insert(key, [f.name])
        with temporary_dir() as staging:
            abs_fn = os.path.join(staging, os.path.basename(f.name))
            assert (not os.path.exists(abs_fn))
            cache.use_cached_files(key, (lambda s, d: shutil.copyfile(s, os.path.join(staging, d))))
            assert os.path.exists(abs_fn)
            with open(abs_fn) as fd:
                assert (fd.read() == TEST_CONTENT)

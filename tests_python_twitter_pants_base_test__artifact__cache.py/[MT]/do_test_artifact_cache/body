def do_test_artifact_cache(artifact_cache):
    key = CacheKey('muppet_key', 'fake_hash', 42)
    with temporary_file(artifact_cache.artifact_root) as f:
        f.write(TEST_CONTENT1)
        path = f.name
        f.close()
        assert (not artifact_cache.has(key))
        assert (not artifact_cache.use_cached_files(key))
        artifact_cache.insert(key, [path])
        assert artifact_cache.has(key)
        with open(path, 'w') as outfile:
            outfile.write(TEST_CONTENT2)
        assert artifact_cache.use_cached_files(key)
        with open(path, 'r') as infile:
            content = infile.read()
        assert (content == TEST_CONTENT1)
        artifact_cache.delete(key)
        assert (not artifact_cache.has(key))

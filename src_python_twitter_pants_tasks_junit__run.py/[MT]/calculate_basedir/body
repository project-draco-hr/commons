def calculate_basedir(filepath):
    with open(filepath, 'r') as source:
        for line in source:
            match = PACKAGE_PARSER.match(line)
            if match:
                package = match.group(1)
                packagedir = package.replace('.', '/')
                dirname = os.path.dirname(filepath)
                if (not dirname.endswith(packagedir)):
                    raise TaskError(('File %s declares a mismatching package %s' % (file, package)))
                return dirname[:(- len(packagedir))]
    raise TaskError(('Could not calculate a base dir for: %s' % file))

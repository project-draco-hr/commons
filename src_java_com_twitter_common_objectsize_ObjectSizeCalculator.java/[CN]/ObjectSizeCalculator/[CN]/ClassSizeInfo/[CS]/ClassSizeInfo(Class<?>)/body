{
  long fieldsSize=0;
  final List<Field> referenceFields=new LinkedList<Field>();
  for (  Field f : clazz.getDeclaredFields()) {
    if (Modifier.isStatic(f.getModifiers())) {
      continue;
    }
    final Class<?> type=f.getType();
    if (type.isPrimitive()) {
      fieldsSize+=getPrimitiveFieldSize(type);
    }
 else {
      f.setAccessible(true);
      referenceFields.add(f);
      fieldsSize+=REFERENCE_SIZE;
    }
  }
  final Class<?> superClass=clazz.getSuperclass();
  if (superClass != null) {
    final ClassSizeInfo superClassInfo=classSizeInfos.get(superClass);
    fieldsSize+=roundTo(superClassInfo.fieldsSize,SUPERCLASS_FIELD_PADDING);
    referenceFields.addAll(Arrays.asList(superClassInfo.referenceFields));
  }
  this.fieldsSize=fieldsSize;
  this.objectSize=roundTo(OBJECT_HEADER_SIZE + fieldsSize,OBJECT_PADDING);
  this.referenceFields=referenceFields.toArray(new Field[referenceFields.size()]);
}

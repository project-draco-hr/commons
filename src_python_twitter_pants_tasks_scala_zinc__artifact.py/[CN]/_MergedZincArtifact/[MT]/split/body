def split(self, old_state=None, portable=False):
    'Actually split the merged artifact into per-target artifacts.'
    current_state = self.current_state()
    if (len(self.underlying_artifacts) <= 1):
        return current_state
    with self.factory.context.new_workunit(name='split'):
        diff = (ZincArtifactStateDiff(old_state, current_state) if old_state else None)
        if ((not diff) or diff.analysis_changed):
            with self.factory.context.new_workunit(name='analysis'):
                self._split_analysis('analysis_file')
                if portable:
                    self._split_analysis('portable_analysis_file')
        with self.factory.context.new_workunit(name='classes'):
            self._split_classes_dir(current_state, diff)
    return current_state

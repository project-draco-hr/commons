def runjava(jvmargs=None, classpath=None, main=None, args=None, only_write_cmd_line_to=None, run_async=False):
    'Spawns a java process with the supplied configuration and returns its exit code.'
    cmd = ['java']
    if jvmargs:
        cmd.extend(jvmargs)
    if classpath:
        cmd.extend((('-cp' if main else '-jar'), os.pathsep.join(classpath)))
    if main:
        cmd.append(main)
    if args:
        cmd.extend(args)
    if (only_write_cmd_line_to is not None):
        only_write_cmd_line_to.write(' '.join(cmd))
        return 0
    else:
        log.debug(('Executing: %s' % ' '.join(cmd)))
        with safe_classpath():
            if run_async:
                return subprocess.Popen(cmd)
            else:
                return subprocess.call(cmd)

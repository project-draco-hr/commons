def execute(self, targets):
    gentargets = [t for t in targets if self.is_gentarget(t)]
    capabilities = self.genlangs()
    gentargets_by_dependee = self.context.dependants(on_predicate=self.is_gentarget, from_predicate=(lambda t: (not self.is_gentarget(t))))
    dependees_by_gentarget = defaultdict(set)
    for (dependee, tgts) in gentargets_by_dependee.items():
        for gentarget in tgts:
            dependees_by_gentarget[gentarget].add(dependee)

    def find_gentargets(predicate):
        tgts = set()
        for dependee in gentargets_by_dependee.keys():
            if predicate(dependee):
                for tgt in gentargets_by_dependee.pop(dependee):
                    tgt.walk(tgts.add, self.is_gentarget)
        return tgts.intersection(set(gentargets))
    gentargets_bylang = {}
    for (lang, predicate) in capabilities.items():
        gentargets_bylang[lang] = (gentargets if self.is_forced(lang) else find_gentargets(predicate))
    if gentargets_by_dependee:
        self.context.log.warn(('Left with unexpected unconsumed gen targets:\n\t%s' % '\n\t'.join((('%s -> %s' % (dependee, gentargets)) for (dependee, gentargets) in gentargets_by_dependee.items()))))
    with self.changed(gentargets, invalidate_dependants=True) as changed_targets:
        changed = set(changed_targets)
        for (lang, tgts) in gentargets_bylang.items():
            lang_changed = changed.intersection(tgts)
            if lang_changed:
                self.genlang(lang, lang_changed)
    for (lang, tgts) in gentargets_bylang.items():
        if tgts:
            langtarget_by_gentarget = {}
            for target in tgts:
                langtarget_by_gentarget[target] = self.createtarget(lang, target, dependees_by_gentarget.get(target, []))
            genmap = self.context.products.get(lang)
            for (gentarget, langtarget) in langtarget_by_gentarget.items():
                genmap.add(gentarget, get_buildroot(), [langtarget])
                for dep in self.getdependencies(gentarget):
                    if self.is_gentarget(dep):
                        self.updatedependencies(langtarget, langtarget_by_gentarget[dep])

def _walk(self, walked, work, predicate=None):
    for target in self.resolve():
        if (target not in walked):
            walked.add(target)
            if ((not predicate) or predicate(target)):
                additional_targets = work(target)
                if hasattr(target, '_walk'):
                    target._walk(walked, work, predicate)
                if additional_targets:
                    for additional_target in additional_targets:
                        if hasattr(additional_target, '_walk'):
                            additional_target._walk(walked, work, predicate)

def build_egg(self):
    self.run_thrifts()
    genpy_root = os.path.join(self.chroot.path(), self.codegen_root, 'gen-py')
    for (dir, subdirs, files) in os.walk(os.path.normpath(genpy_root)):
        reldir = os.path.relpath(dir, genpy_root)
        if (reldir == '.'):
            continue
        if ('__init__.py' not in files):
            continue
        self.detected_packages.add(self.path_to_module(reldir))
    if (not self.detected_packages):
        raise PythonThriftBuilder.CodeGenerationException(('No Thrift structures declared in %s!' % self.target))

    def dump_setup_py(packages):
        boilerplate = '\nfrom setuptools import setup\n\nsetup(name        = "%(target_name)s",\n      version     = "dev",\n      description = "autogenerated thrift bindings for %(target_name)s",\n      package_dir = { "": "gen-py" },\n      packages    = %(packages)s)\n'
        boilerplate = (boilerplate % {'target_name': self.target.name, 'genpy_root': genpy_root, 'packages': repr(list(packages)), })
        self.chroot.write(boilerplate, os.path.join(self.codegen_root, 'setup.py'))
    dump_setup_py(self.detected_packages)
    egg_path = None
    cwd = os.getcwd()
    egg_root = os.path.join(self.chroot.path(), self.codegen_root)
    os.chdir(egg_root)
    po = subprocess.Popen([sys.executable, 'setup.py', 'bdist_egg', '--dist-dir=dist', ('--bdist-dir=build.%s' % self.target.name)], stderr=subprocess.PIPE, stdout=subprocess.PIPE)
    rv = po.wait()
    if (rv == 0):
        eggs = os.path.abspath(os.path.join('dist', '*.egg'))
        eggs = glob.glob(eggs)
        if (len(eggs) != 1):
            comm = po.communicate()
            print  >> sys.stderr, 'egg generation failed'
            print  >> sys.stderr, 'STDOUT'
            print  >> sys.stderr, comm[0]
            print  >> sys.stderr, 'STDERR'
            print  >> sys.stderr, comm[1]
            raise PythonThriftBuilder.CodeGenerationException(('Generation of Thrift eggs failed for target = %s' % self.target))
        egg_path = eggs[0]
    os.chdir(cwd)
    return egg_path

def _update_endpoints(self, _1, event, state, _2):
    'Update endpoints from ZK.\n\n    This function will block until the ZK servers respond or retry limit is hit.\n\n    :raises ReconnectFailed: If reconnection fails.\n    '
    if ((not ((state == zookeeper.CONNECTED_STATE) and (event == zookeeper.CHILD_EVENT))) and (not (state == zookeeper.EXPIRED_SESSION_STATE))):
        return
    try:
        endpoints = []
        endpoint_names = self._zk.get_children(self._endpoint, self._update_endpoints)
        endpoint_names.sort()
        for endpoint in endpoint_names:
            data = self._zk.get(posixpath.join(self._endpoint, endpoint))
            service_endpoint = serverset_types.ServiceInstance()
            endpoints.append(codec.deserialize(service_endpoint, data[0]))
        old = set(map(_format_endpoint, self._endpoints))
        new = set(map(_format_endpoint, endpoints))
        log.debug(('ServerSet endpoints at %r changed to: %s' % (self._endpoint, ', '.join(new))))
        log.debug(('  Added: %s' % ', '.join((new - old))))
        log.debug(('  Removed: %s' % ', '.join((old - new))))
        with self._lock:
            if self._watcher:
                self._watcher(self._endpoint, self._endpoints, endpoints)
            self._endpoints = endpoints
    except ZooKeeper.Error as e:
        log.error(('Lost connection to ZooKeeper: %s, reestablishing.' % e))
        self._reconnect()

def test_filtering_vars_filter_enabled_and_requested(self):
    rm = RootMetrics()
    zone = NamedGauge('alpha', 'wont_be_visible')
    alpha = NamedGauge('zone', 'smf1')
    rm.register(zone)
    rm.register(alpha)
    metrics = RootMetrics()
    vars_subsystem = VarsSubsystem()
    regex = vars_subsystem.compile_stats_filters(['alpha', 'beta.*'])
    endpoint = VarsEndpoint(period=Amount(60000, Time.MILLISECONDS), stats_filter=regex)
    request.GET.append('filtered', '1')
    metrics_returned = endpoint.handle_vars_json()
    assert ('zone' in metrics_returned)
    assert ('alpha' not in metrics_returned)
    request.GET.replace('filtered', None)

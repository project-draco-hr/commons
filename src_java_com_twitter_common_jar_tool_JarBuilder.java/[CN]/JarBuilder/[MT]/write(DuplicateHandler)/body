{
  final Iterable<ReadableEntry> merged=getEntries(duplicateHandler);
  FileUtils.SYSTEM_TMP.doWithFile(new ExceptionalClosure<File,IOException>(){
    @Override public void execute(    File tmp) throws IOException {
      try {
        JarWriter writer=jarWriter(tmp);
        writer.write(JarFile.MANIFEST_NAME,manifest == null ? DEFAULT_MANIFEST : manifest);
        for (        ReadableEntry entry : merged) {
          writer.write(entry.getJarPath(),entry.contents);
        }
      }
 catch (      IOException e) {
        throw closer.rethrow(e);
      }
 finally {
        closer.close();
      }
      if (!tmp.renameTo(target)) {
        throw new JarCreationException(String.format("Problem moving created jar from %s to %s",tmp,target));
      }
    }
  }
);
  return target;
}

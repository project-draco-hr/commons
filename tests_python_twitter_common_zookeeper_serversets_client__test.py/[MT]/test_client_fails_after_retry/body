def test_client_fails_after_retry():
    cluster = ZookeeperClusterBootstrapper()
    port = cluster.start(1)
    server = ('localhost:%d' % port)
    zk = ZooKeeper(server, timeout=3)
    service = ServerSet(zk, SERVICE_PATH)
    service.register(INSTANCE1)
    client = ServerSetClient(SERVICE_PATH, zk=zk, retries=1)
    assert (list(client) == [INSTANCE1])
    cluster.stop(1)
    with pytest.raises(ServerSetClient.ReconnectFailed):
        list(client)

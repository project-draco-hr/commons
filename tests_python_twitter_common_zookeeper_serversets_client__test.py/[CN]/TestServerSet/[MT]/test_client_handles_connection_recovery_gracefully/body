def test_client_handles_connection_recovery_gracefully(self):
    sync_log('test_client_handles_connection_recovery_gracefully')
    zk = ZooKeeper(self._server.ensemble, logger=sync_log)
    sync_log('Creating serverset.')
    service = ServerSet(zk, SERVICE_PATH)
    sync_log('  done')
    sync_log('Registering instance...')
    service.register(INSTANCE1)
    sync_log('  done')
    client = ServerSetClient(SERVICE_PATH, zk=zk)
    assert (list(client) == [INSTANCE1])
    threading.Timer(3.0, (lambda : self._server.start())).start()
    self._server.shutdown()
    time.sleep(1.0)
    assert (list(client) == [INSTANCE1])
    sync_log('success.')
    zk.close()

def test_monitor_through_parent_death(self):
    zkg = self.GroupImpl(self._zk, '/test')
    membership_event = threading.Event()
    members = set()

    def new_membership(m):
        members.update(m)
        membership_event.set()
    zkg.monitor(callback=new_membership)
    membership = zkg.join('hello world')
    assert (membership != Membership.error())
    membership_event.wait(timeout=self.MAX_EVENT_WAIT_SECS)
    assert membership_event.is_set()
    assert (members == set([membership]))
    membership_event.clear()
    members.clear()
    zkg.monitor(set([membership]), callback=new_membership)
    zkg.cancel(membership)
    membership_event.wait(timeout=self.MAX_EVENT_WAIT_SECS)
    assert membership_event.is_set()
    assert (members == set())
    membership_event.clear()
    members.clear()
    zkg.monitor(callback=new_membership)
    self._zk.delete('/test')
    membership = zkg.join('hello world 2')
    assert (membership != Membership.error())
    membership_event.wait(timeout=self.MAX_EVENT_WAIT_SECS)
    assert membership_event.is_set()
    assert (members == set([membership]))

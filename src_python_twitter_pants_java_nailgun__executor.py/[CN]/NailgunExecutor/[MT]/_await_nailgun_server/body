def _await_nailgun_server(self, stdout, stderr):
    nailgun_timeout_seconds = 5
    max_socket_connect_attempts = 10
    nailgun = None
    port_parse_start = time.time()
    with safe_open(self._ng_out, 'r') as ng_out:
        while (not nailgun):
            started = ng_out.readline()
            if started:
                port = self._parse_nailgun_port(started)
                nailgun = self._create_ngclient(port, stdout, stderr)
                log.debug(('Detected ng server up on port %d' % port))
            elif ((time.time() - port_parse_start) > nailgun_timeout_seconds):
                raise NailgunClient.NailgunError(('Failed to read ng output after %s seconds' % nailgun_timeout_seconds))
    attempt = 0
    while nailgun:
        sock = nailgun.try_connect()
        if sock:
            sock.close()
            endpoint = self._get_nailgun_endpoint()
            if endpoint:
                log.debug(('Connected to ng server with fingerprint %s pid: %d @ port: %d' % endpoint))
            else:
                raise NailgunClient.NailgunError('Failed to connect to ng server.')
            return nailgun
        elif (attempt > max_socket_connect_attempts):
            raise nailgun.NailgunError(('Failed to connect to ng output after %d connect attempts' % max_socket_connect_attempts))
        attempt += 1
        log.debug(('Failed to connect on attempt %d' % attempt))
        time.sleep(0.1)

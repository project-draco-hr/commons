def compile(self, classpath, sources, output_dir, analysis_cache, upstream_analysis_caches, depfile):
    safe_mkdir(output_dir)
    compiler_classpath = nailgun_profile_classpath(self, self._compile_profile)
    compiler_args = []
    compiler_args.extend([('-Xplugin:%s' % self.get_depemitter_plugin()), ('-P:depemitter:file:%s' % depfile)])
    compiler_args.extend(self._args)
    args = [('-S' + x) for x in compiler_args]

    def analysis_cache_full_path(analysis_cache_product):
        if (len(analysis_cache_product) != 1):
            raise TaskError('There can only be one analysis cache file per output directory')
        (analysis_cache_dir, analysis_cache_files) = analysis_cache_product.iteritems().next()
        if (len(analysis_cache_files) != 1):
            raise TaskError('There can only be one analysis cache file per output directory')
        return os.path.join(analysis_cache_dir, analysis_cache_files[0])
    analysis_map = OrderedDict([(k, analysis_cache_full_path(v)) for (k, v) in upstream_analysis_caches.itermappings()])
    if (len(analysis_map) > 0):
        args.extend(['-analysis-map', ','.join([('%s:%s' % kv) for kv in analysis_map.items()])])
    upstream_classes_dirs = analysis_map.keys()
    zinc_classpath = nailgun_profile_classpath(self, self._zinc_profile)
    zinc_jars = ScalaCompile.identify_zinc_jars(compiler_classpath, zinc_classpath)
    for (name, jarpath) in zinc_jars.items():
        args.extend([('-%s' % name), jarpath])
    args.extend(['-analysis-cache', analysis_cache, '-log-level', (self.context.options.log_level or 'info'), '-classpath', ':'.join(((zinc_classpath + classpath) + upstream_classes_dirs)), '-d', output_dir])
    if (not self._color):
        args.append('-no-color')
    args.extend(sources)
    self.context.log.debug(('Executing: %s %s' % (self._main, ' '.join(args))))
    return self.runjava(self._main, classpath=zinc_classpath, args=args, jvmargs=self._jvm_args)

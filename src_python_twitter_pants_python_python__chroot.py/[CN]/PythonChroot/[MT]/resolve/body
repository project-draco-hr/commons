def resolve(self, targets):
    children = defaultdict(OrderedSet)

    def add_dep(trg):
        if is_concrete(trg):
            for (target_type, target_key) in self._VALID_DEPENDENCIES.items():
                if isinstance(trg, target_type):
                    children[target_key].add(trg)
                    return
        raise self.InvalidDependencyException(trg)
    for target in targets:
        target.walk(add_dep)
    return children

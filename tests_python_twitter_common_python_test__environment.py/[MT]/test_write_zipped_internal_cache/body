def test_write_zipped_internal_cache():
    with nested(yield_pex_builder(zip_safe=True), temporary_dir(), temporary_file()) as (pb, pex_root, pex_file):
        pex = pb.path()
        pb.info.pex_root = pex_root
        pb.build(pex_file.name)
        dists = PEXEnvironment.write_zipped_internal_cache(pex_file.name, pb.info)
        assert (len(dists) == 1)
        assert normalize(dists[0].location).startswith(normalize(os.path.join(pex_file.name, pb.info.internal_cache)))
        pb.info.always_write_cache = True
        dists = PEXEnvironment.write_zipped_internal_cache(pex_file.name, pb.info)
        assert (len(dists) == 1)
        assert normalize(dists[0].location).startswith(normalize(pb.info.install_cache))
    with nested(yield_pex_builder(zip_safe=False), temporary_dir(), temporary_file()) as (pb, pex_root, pex_file):
        pex = pb.path()
        pb.info.pex_root = pex_root
        pb.build(pex_file.name)
        dists = PEXEnvironment.write_zipped_internal_cache(pex_file.name, pb.info)
        assert (len(dists) == 1)
        assert normalize(dists[0].location).startswith(normalize(pb.info.install_cache))
        original_location = normalize(dists[0].location)
        dists = PEXEnvironment.write_zipped_internal_cache(pex_file.name, pb.info)
        assert (len(dists) == 1)
        assert (normalize(dists[0].location) == original_location)
